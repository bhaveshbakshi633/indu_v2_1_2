# V2.1.3.0 - Arm Controller Bug Fixes

## Release Date: 2026-01-14

---

## **WORKING BACKUP - REVERT POINT**

**Backup Location:** `~/deployed/backups/v2_1_v2.7_working_20260114_121839/`

**Docker Image:** `g1_orchestrator:v2.7`

**Status:** FULLY TESTED - init_arms, move_home, move_to, stop, cancel ALL WORKING

**Revert Command:**
```bash
cd ~/deployed
rm -rf v2_1
cp -r backups/v2_1_v2.7_working_20260114_121839 v2_1
docker-compose -f v2_1/docker-compose.yml up -d
```

---

## Quick Start Commands

### Start Services
```bash
cd ~/deployed/v2_1
docker-compose up
```

### Enter Docker Containers
```bash
# Orchestrator container
sudo docker exec -it g1_orchestrator bash

# Arm controller container
sudo docker exec -it arm_controller bash
source /ros2_ws/install/setup.bash
```

### Orchestrator Commands
```bash
# Get FSM state
ros2 topic pub --once /orchestrator/action_command orchestrator_msgs/msg/ActionCommand '{action_name: "getfsm", parameters: [], priority: 1}'

# Init robot (standup sequence)
ros2 topic pub --once /orchestrator/action_command orchestrator_msgs/msg/ActionCommand '{action_name: "init", parameters: [], priority: 1}'

# Damp robot (safe shutdown)
ros2 topic pub --once /orchestrator/action_command orchestrator_msgs/msg/ActionCommand '{action_name: "damp", parameters: [], priority: 1}'

# Status check
ros2 topic pub --once /orchestrator/action_command orchestrator_msgs/msg/ActionCommand "{action_name: status}"
```

### Arm Controller Commands
```bash
# Init arms (stiffness ramp)
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'init_arms'"

# Move to home
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'move_home'"

# Move to custom position
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'move_to:{\"left\": [0.3, 0.2, 0.0, 0.8, 0.0, 0.0, 0.0], \"right\": [0.3, -0.2, 0.0, 0.8, 0.0, 0.0, 0.0]}'"

# Extended position
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'move_to:{\"left\": [0.5, 0.3, 0.0, 1.0, 0.0, 0.0, 0.0], \"right\": [0.5, -0.3, 0.0, 1.0, 0.0, 0.0, 0.0]}'"

# Stop motion
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'stop'"

# Cancel task
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'cancel'"

# Teach mode
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'enter_teach'"
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'record'"
ros2 topic pub --once /arm_ctrl/command std_msgs/String "data: 'exit_teach'"
```

---

## Bug #1: Deadlock in init_arms

**Symptom:** init_arms command hangs at "Step 2: Capturing hold position"

**Root Cause:**
- initArms() called synchronously inside commandCallback()
- ROS2 executor thread blocked during sleep_for() calls
- lowstateCallback() waiting for mutex held by initArms()
- Result: Circular wait = deadlock

**Fix:**
- Worker thread pattern for long operations
- std::thread worker_thread_ runs initArmsWorker()
- std::atomic<bool> task_running_ prevents concurrent ops
- Mutex scope minimized: copy data, release, process

**File:** arm_controller_node.cpp lines 280-320

---

## Bug #2: Brace Placement in lowstateCallback

**Symptom:** NaN safety check not working correctly

**Root Cause:**
NaN check loop was incorrectly nested inside WAIST for loop due to wrong brace placement. Only checked NaN for WAIST joints, not all arm joints.

**Fix:**
Moved closing brace to correct position. NaN check now runs after all position updates complete.

**File:** arm_controller_node.cpp lines 119-143

---

## Bug #3: Wrong FSM Reading

**Symptom:** FSM shows 5 when robot is actually in 801 (READY)

**Root Cause:**
- mode_machine from LowState msg != actual FSM from API
- LowState.mode_machine can be stale/different value
- Code was checking wrong variable for FSM state

**Fix:**
- Added getFsmId() API call (matches g1_orchestrator pattern)
- FSM polling thread updates cached_fsm_ every 200ms
- All FSM checks use cached_fsm_.load() not mode_machine_

**Files:**
- arm_controller.hpp - added cached_fsm_, getFsmId(), API pub/sub
- arm_controller_node.cpp - FSM polling thread, API response handling
- CMakeLists.txt - added unitree_api dependency
- package.xml - added unitree_api dependency

---

## Bug #4: No Cancel Command

**Symptom:** No way to abort stuck/running operations

**Root Cause:** Missing cancellation mechanism

**Fix:**
- std::atomic<bool> task_cancel_requested_
- cancel command sets flag to true
- checkCancelled() helper function
- All loops check: while (running_ && !checkCancelled())

**File:** arm_controller_node.cpp lines 283-290, all worker functions

---

## Bug #5: FSM Pre-check Missing

**Symptom:** init_arms starts even when FSM != 801, causes blocked warnings

**Root Cause:** No FSM validation before starting init sequence

**Fix:**
- init_arms waits up to 30s for FSM=801
- Polls cached_fsm_ every 100ms
- Fails with error if timeout

**File:** arm_controller_node.cpp lines 528-540

---

## Bug #6: Wrong arm_sdk Topic Name (CRITICAL)

**Symptom:** Arms don't move during move_home, safety fault after ~2.3s

**Root Cause:**
- C++ publishes to: rt/arm_sdk (0 subscribers)
- Robot listens on: /arm_sdk (1 subscriber)
- Commands sent to void, arm doesn't receive them
- commanded_pos_ updates via blend, current_pos_ stays static
- Position error grows until 0.3 rad limit = safety fault

**Diagnosis:**
```
ros2 topic info /rt/arm_sdk   # Publisher: 1, Subscription: 0
ros2 topic info /arm_sdk      # Publisher: 1, Subscription: 1
```

**Fix:**
Changed topic from "rt/arm_sdk" to "arm_sdk" in publisher creation.

**File:** arm_controller_node.cpp line 40

---

## Summary Table

| Bug | Severity | Impact |
|-----|----------|--------|
| #1 Deadlock | Critical | System hang |
| #2 Brace bug | Medium | Safety check ineffective |
| #3 FSM reading | High | Commands blocked incorrectly |
| #4 No cancel | Medium | No abort capability |
| #5 FSM pre-check | Low | Unnecessary warnings |
| #6 Topic name | Critical | Arms completely non-functional |

---

## Docker Version: v2.7

---

## PENDING: V2.1.4.0 Features/Bugs

### Bug #7: Teach Mode Position Error on Entry
**Symptom:** Position error warnings when entering teach mode and moving arms
**Root Cause:** commanded_pos_ not cleared/synced to current_pos_ on teach entry
**Required Fix:** On enter_teach, set commanded_pos_ = current_pos_ and disable position error check in TEACH state

### Bug #8: Teach Mode State Transition Issue
**Symptom:** Position error after exit_teach even during damp
**Root Cause:** State transitions not intelligent - safety checks active when they shouldn't be
**Required Fix:** Proper state machine with safety check gating per state

### Feature #1: Continuous Recording with Timestamps
**Current:** record command captures single snapshot
**Required:**
- start_recording / stop_recording commands
- Capture position + timestamp pairs at 500Hz
- Store as trajectory with timing info

### Feature #2: Play Command with Exact Timing
**Current:** No playback feature
**Required:**
- play command to replay recorded trajectory
- Exact timing preservation (not faster/slower)
- Smooth blend between recorded points
