version: '2.4'

services:
  # AUDIO SERVICES - Start FIRST (no dependencies)
  tts_audio_player:
    image: g1_orchestrator:v2.13
    container_name: tts_audio_player
    hostname: tts_audio_player
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: ros2 run audio_player tts_audio_player

  audio_receiver:
    image: g1_orchestrator:v2.13
    container_name: audio_receiver
    hostname: audio_receiver
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src/audio_player/scripts/audio_receiver.py:/ros2_ws/install/audio_player/lib/audio_player/audio_receiver.py:ro
      - ./src/audio_player/scripts/announcer_utils.py:/ros2_ws/install/audio_player/lib/audio_player/announcer_utils.py:ro
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: python3 /ros2_ws/install/audio_player/lib/audio_player/audio_receiver.py
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 5s

  # STARTUP HEALTH CHECK
  startup_health_check:
    image: g1_orchestrator:v2.13
    container_name: startup_health_check
    hostname: startup_health_check
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - GAIN=${GAIN:-0.5}
    volumes:
      - ./src/audio_player/scripts/startup_health_check.py:/ros2_ws/install/audio_player/lib/audio_player/startup_health_check.py:ro
      - ./src/audio_player/scripts/announcer_utils.py:/ros2_ws/install/audio_player/lib/audio_player/announcer_utils.py:ro
      - ./config:/ros2_ws/config:ro
    depends_on:
      audio_receiver:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: python3 /ros2_ws/install/audio_player/lib/audio_player/startup_health_check.py
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/startup_complete"]
      interval: 3s
      timeout: 2s
      retries: 60
      start_period: 10s

  # MAIN SERVICES
  g1_orchestrator:
    image: g1_orchestrator:v2.13
    container_name: g1_orchestrator
    hostname: g1_orchestrator
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./config:/ros2_ws/config:ro
      - ./docker_build/install/g1_orchestrator/lib/g1_orchestrator/g1_orchestrator_node:/ros2_ws/install/g1_orchestrator/lib/g1_orchestrator/g1_orchestrator_node:ro
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: ros2 run g1_orchestrator g1_orchestrator_node

  arm_controller:
    image: g1_orchestrator:v2.13
    container_name: arm_controller
    hostname: arm_controller
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - GAIN=${GAIN:-0.5}
    volumes:
      - ./config:/ros2_ws/config:ro
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: ros2 run arm_controller arm_controller_node

  status_announcer:
    image: g1_orchestrator:v2.13
    container_name: status_announcer
    hostname: status_announcer
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - GAIN=${GAIN:-0.5}
    volumes:
      - ./src/audio_player/scripts/announcer_utils.py:/ros2_ws/install/audio_player/lib/audio_player/announcer_utils.py:ro
      - ./config:/ros2_ws/config:ro
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: python3 /ros2_ws/install/audio_player/lib/audio_player/status_announcer.py

  # ============================================================
  # SHAKAL - Face Recognition (CPU-only)
  # Topics: /shakal/names, /shakal/faces
  # Services: /shakal/enroll, /shakal/remove, /shakal/list_persons
  # ============================================================
  shakal:
    image: g1_orchestrator:v2.tanay
    container_name: shakal
    hostname: shakal
    network_mode: host
    privileged: true
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CUDA_VISIBLE_DEVICES=
    volumes:
      - /home/unitree/deployed/v2_tanay/src/shakal_ros/config/shakal_params.yaml:/ros2_ws/install/shakal_ros/share/shakal_ros/config/shakal_params.yaml
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: ros2 launch shakal_ros shakal.launch.py

  # ============================================================
  # HTTP ACTION BRIDGE - Voice commands via HTTP
  # Endpoint: POST http://172.16.2.242:5051/action
  # Publishes to: /voice/action_request
  # ============================================================
  http_action_bridge:
    image: g1_orchestrator:v2.13
    container_name: http_action_bridge
    hostname: http_action_bridge
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src/http_action_bridge/http_action_bridge/bridge_node.py:/ros2_ws/bridge_node.py:ro
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: python3 /ros2_ws/bridge_node.py

  talking_gestures:
    image: g1_orchestrator:v2.13
    container_name: talking_gestures
    hostname: talking_gestures
    network_mode: host
    privileged: true
    runtime: nvidia
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    volumes:
      - ./src/audio_player/scripts/talking_gestures.py:/ros2_ws/talking_gestures.py:ro
    depends_on:
      startup_health_check:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: python3 /ros2_ws/talking_gestures.py
